{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mt-5 pt-5">
    <div class="row">
        <div class="col-md-12">
            <!-- Datos de la factura -->
            <div class="card card-secondary">
                <div class="card-header">
                    <h6 class="card-title"><i class="fas fa-shopping-cart"></i> Datos de la factura</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            {{ form_venta.id_cliente }}
                        </div>
                        <div class="col-md-4">
                            {{ form_venta.fecha }}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Agregar Producto -->
            <div class="mt-4">
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title"><i class="fas fa-shopping-cart"></i> Agregar Producto</h6>
                    </div>
                    <form id="formAddProducto" onsubmit="event.preventDefault(); agregarProducto();">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form_add_venta_detalle.id_producto.id_for_label }}">
                                        {{ form_add_venta_detalle.id_producto.label }}
                                    </label>
                                    {{ form_add_venta_detalle.id_producto }}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form_add_venta_detalle.cantidad.id_for_label }}">
                                        {{ form_add_venta_detalle.cantidad.label }}
                                    </label>
                                    {{ form_add_venta_detalle.cantidad }}
                                </div>
                                <div class="col-md-3">
                                    <label for="{{ form_add_venta_detalle.descuento.id_for_label }}">
                                        {{ form_add_venta_detalle.descuento.label }}
                                    </label>
                                    {{ form_add_venta_detalle.descuento }}
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn btn-success">
                                    Agregar Producto
                                    <i class="fas fa-plus-circle"></i>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <!-- Detalle del carrito -->
            <div class="card mt-4" style="overflow:scroll">
                <table class="table table-hover table-primary" id="tblProducts">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Descuento</th>
                            <th>Opciones</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <!-- Botón pagar -->
            <div class="row mt-4">
                <button onclick="pagar_carrito()" type="button" class="btn btn-success">
                    Pagar carrito
                    <i class="fas fa-plus-circle"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let carrito = [];

function agregarProducto() {
    const id_producto = document.getElementById('id_producto_add').value;
    const nombre_producto = document.getElementById('id_producto_add').selectedOptions[0].text;
    const cantidad = document.getElementById('cantidad_add').value;
    const descuento = document.getElementById('descuento_add').value;

    if (!id_producto || !cantidad) {
        alert("Selecciona producto y cantidad");
        return;
    }

    carrito.push({id_producto, nombre_producto, cantidad, descuento});
    renderCarrito();

    // Limpia los campos
    document.getElementById('id_producto').selectedIndex = 0;
    document.getElementById('id_cantidad').value = '';
    document.getElementById('id_descuento').value = '';
}

function renderCarrito() {
    const tbody = document.querySelector('#tblProducts tbody');
    tbody.innerHTML = '';
    carrito.forEach((item, idx) => {
        tbody.innerHTML += `<tr>
            <td>${item.nombre_producto}</td>
            <td>${item.cantidad}</td>
            <td>${item.descuento || ''}</td>
            <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${idx})">Eliminar</button></td>
        </tr>`;
    });
}

function eliminarProducto(idx) {
    carrito.splice(idx, 1);
    renderCarrito();
}

function pagar_carrito() {
    const id_cliente = document.getElementById('id_cliente_add').value;
    const fecha = document.getElementById('fecha_add').value;

    if (!id_cliente || !fecha || carrito.length === 0) {
        alert("Selecciona cliente, fecha y agrega al menos un producto.");
        return;
    }

    // Crea un formulario y lo envía por POST
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{% url 'AddCarrito' %}";

    // CSRF token
    const csrf = document.createElement('input');
    csrf.type = 'hidden';
    csrf.name = 'csrfmiddlewaretoken';
    csrf.value = '{{ csrf_token }}';
    form.appendChild(csrf);

    // Cliente y fecha
    form.innerHTML += `<input type="hidden" name="id_cliente_add" value="${id_cliente}">`;
    form.innerHTML += `<input type="hidden" name="fecha_add" value="${fecha}">`;

    // Productos
    carrito.forEach((item) => {
        form.innerHTML += `<input type="hidden" name="nplainArray[]" value="${item.id_producto},${item.cantidad},${item.descuento}">`;
    });

    document.body.appendChild(form);
    form.submit();
}
</script>

{% if messages %}
{% for message in messages %}
<script>
    Swal.fire({
        text: "{{message}}",
    })
</script>
{% endfor %}
{% endif %}
{% endblock %}